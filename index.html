<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Catatan Chord Lagu</title>
  <style>
    :root {
      --bg: #0e0f13;
      --card: #161822;
      --card-soft: #1d2030;
      --primary: #4da3ff;
      --text: #e9ebf0;
      --muted: #9aa0b4;
      --border: #2a2d3e;
      --shadow: rgba(0, 0, 0, 0.3);
      --transition: all 0.3s ease;
    }
    * {
      box-sizing: border-box;
    }
    body {
      margin: 0;
      font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
      transition: var(--transition);
      min-height: 100vh;
    }
    h1 {
      font-size: 18px;
      font-weight: 600;
      margin: 0;
      padding: 16px 20px;
      background: linear-gradient(180deg, #161822, #121420);
      border-bottom: 1px solid var(--border);
      box-shadow: 0 2px 4px var(--shadow);
    }
    h2 {
      font-size: 16px;
      font-weight: 500;
      margin: 20px 0 10px;
      color: var(--primary);
    }
    button {
      appearance: none;
      border: none;
      background: var(--card-soft);
      color: var(--text);
      padding: 10px 14px;
      border-radius: 12px;
      font-size: 14px;
      cursor: pointer;
      transition: var(--transition);
      box-shadow: 0 1px 3px var(--shadow);
    }
    button:hover {
      background: #262a3d;
      transform: translateY(-1px);
    }
    button:active {
      transform: scale(0.96);
    }
    .hidden {
      display: none;
    }
    .fade-in {
      animation: fadeIn 0.5s ease-in-out;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* MODAL */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }
    .modal.show {
      display: flex;
    }
    .modal-content {
      background: var(--bg);
      border-radius: 18px;
      padding: 20px;
      max-width: 90%;
      max-height: 90%;
      overflow-y: auto;
      box-shadow: 0 10px 30px var(--shadow);
      width: 100%;
    }
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }
    .modal-close {
      background: none;
      border: none;
      color: var(--muted);
      font-size: 24px;
      cursor: pointer;
    }

    /* PAGE LIST */
    #pageList {
      padding: 20px;
    }
    .group {
      margin-bottom: 30px;
    }
    .song-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      width: 100%;
      text-align: left;
      margin-bottom: 12px;
      padding: 16px 20px;
      background: var(--card);
      border: 1px solid var(--border);
      font-size: 16px;
      border-radius: 14px;
      box-shadow: 0 2px 6px var(--shadow);
      cursor: pointer;
    }
    .song-item:hover {
      background: var(--card-soft);
    }
    .song-title {
      flex: 1;
    }
    .menu-btn {
      background: none;
      border: none;
      color: var(--muted);
      font-size: 18px;
      cursor: pointer;
      padding: 0;
      margin-left: 10px;
    }
    .menu {
      position: relative;
      display: inline-block;
    }
    .menu-content {
      display: none;
      position: absolute;
      right: 0;
      top: 100%;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 8px;
      box-shadow: 0 4px 12px var(--shadow);
      z-index: 100;
      min-width: 120px;
    }
    .menu-content button {
      width: 100%;
      text-align: left;
      border-radius: 0;
      margin: 0;
      padding: 10px 14px;
    }
    .menu-content button:first-child {
      border-radius: 8px 8px 0 0;
    }
    .menu-content button:last-child {
      border-radius: 0 0 8px 8px;
    }

    /* EDITOR IN MODAL */
    .editor-modal textarea {
      width: 100%;
      height: 300px;
      background: var(--card);
      color: var(--text);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 16px;
      font-size: 16px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      resize: vertical;
      transition: var(--transition);
      white-space: pre;
    }
    .editor-modal textarea:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 2px rgba(77, 163, 255, 0.2);
    }
    .editor-modal .actions {
      display: flex;
      gap: 10px;
      margin-top: 16px;
    }

    /* VIEWER */
    .viewer {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 18px;
      padding: 20px;
      margin-top: 16px;
      line-height: 2;
      box-shadow: 0 4px 12px var(--shadow);
      overflow-x: auto;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      white-space: pre;
    }
    .section {
      font-weight: 700;
      letter-spacing: 0.5px;
      margin: 20px 0 8px;
      color: #ffffff;
      font-size: 12px;
    }

    .chord {
      color: var(--primary);
      font-weight: 600;
    }

    /* TOOLBAR */
    .toolbar {
      position: sticky;
      top: 0;
      z-index: 50;
      display: flex;
      gap: 8px;
      padding: 12px 20px;
      background: rgba(14, 15, 19, 0.9);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid var(--border);
      box-shadow: 0 2px 8px var(--shadow);
    }
    .toolbar button {
      font-size: 14px;
    }

    /* RESPONSIVE */
    @media (max-width: 768px) {
      .modal-content {
        max-width: 95%;
        padding: 16px;
      }
      .toolbar {
        padding: 10px 16px;
        flex-wrap: wrap;
      }
      .viewer {
        padding: 16px;
        font-size: 14px;
      }
      h1 {
        font-size: 16px;
        padding: 14px 16px;
      }
      .song-item {
        padding: 14px 16px;
        font-size: 14px;
      }
    }
  </style>
</head>
<body>

<!-- PAGE 1 -->
<div id="pageList" class="fade-in">
  <h1>My Noted</h1>
  <div style="text-align: right; margin-bottom: 20px;">
    <button onclick="exportSongs()">‚¨á Export</button>
    <label for="importFile" style="margin-left: 10px;">
      <button>üìÅ Import</button>
    </label>
    <input type="file" id="importFile" onchange="importSongs(event)" style="display: none;" />
  </div>
  <div class="group">
    <h2>JCC</h2>
    <div id="songButtons1"></div>
  </div>
</div>

<!-- PAGE 2 -->
<div id="pageEditor" class="hidden fade-in">
  <button onclick="backToList()">‚¨Ö Kembali</button>
  <h1 id="songTitle"></h1>

  <div class="toolbar">
    <button onclick="transpose(-1)">‚ûñ Transpose</button>
    <button onclick="transpose(1)">‚ûï Transpose</button>
    <button onclick="zoom(1)">üîç+</button>
    <button onclick="zoom(-1)">üîç-</button>
  </div>

  <div id="viewer" class="viewer"></div>
</div>

<!-- MODAL EDIT -->
<div id="editModal" class="modal">
  <div class="modal-content editor-modal">
    <div class="modal-header">
      <h1 id="editTitle"></h1>
      <button class="modal-close" onclick="closeModal('editModal')">√ó</button>
    </div>
    <textarea id="editor" placeholder="Masukkan chord dan lirik di sini..."></textarea>
    <div class="actions">
      <button onclick="saveSong()">üíæ Simpan</button>
    </div>
  </div>
</div>

<script type="module">
/* ================= FIREBASE ================= */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
  getFirestore,
  doc,
  setDoc,
  collection,
  onSnapshot
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyC1pwhv_VtD1Zkc61kBntnBZWlCLeFSod0",
  authDomain: "catatan-chord-7fa25.firebaseapp.com",
  projectId: "catatan-chord-7fa25",
  storageBucket: "catatan-chord-7fa25.firebasestorage.app",
  messagingSenderId: "559468614740",
  appId: "1:559468614740:web:dd6f9b99e314037524c9c1"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

/* ================= KONFIG ================= */
const TOTAL_PER_GROUP = 10;
const TOTAL_GROUP = 3;
const TOTAL = TOTAL_PER_GROUP * TOTAL_GROUP;
const KEYS = ['C','C#','D','D#','E','F','F#','G','G#','A','Bb','B'];

/* ================= STATE ================= */
let songs = Array(TOTAL).fill('');
let titles = Array.from({ length: TOTAL }, (_, i) => `Lagu ${i % TOTAL_PER_GROUP + 1}`);

let current = 0;
let transposeStep = 0;
let fontSize = 18;

/* scroll */
let lastScrollY = 0;

/* swipe */
let touchStartX = 0;
let touchEndX = 0;
let isAnimating = false;

/* ================= FIRESTORE ================= */
onSnapshot(collection(db, "songs"), snap => {
  snap.forEach(d => {
    const i = parseInt(d.id.replace("song_", ""));
    if (!isNaN(i)) {
      songs[i] = d.data().content || '';
      titles[i] = d.data().title || titles[i];
    }
  });
  init();
});

/* ================= INIT ================= */
function init() {
  renderGroup('songButtons1', 0, TOTAL_PER_GROUP);
  renderGroup('songButtons2', TOTAL_PER_GROUP, TOTAL_PER_GROUP * 2);
  renderGroup('songButtons3', TOTAL_PER_GROUP * 2, TOTAL_PER_GROUP * 3);
}

/* ================= LIST ================= */
function renderGroup(containerId, start, end) {
  const box = document.getElementById(containerId);
  box.innerHTML = '';

  for (let i = start; i < end; i++) {
    const item = document.createElement('div');
    item.className = 'song-item';
    item.onclick = () => viewSong(i);

    item.innerHTML = `
      <span class="song-title">${titles[i]}</span>
      <div class="menu">
        <button class="menu-btn" onclick="event.stopPropagation(); toggleMenu(${i})">‚ãÆ</button>
        <div id="menu-${i}" class="menu-content">
          <button onclick="event.stopPropagation(); editTitle(${i})">Edit Judul</button>
          <button onclick="event.stopPropagation(); editSong(${i})">Edit Lagu</button>
        </div>
      </div>
    `;
    box.appendChild(item);
  }
}

function toggleMenu(i) {
  document.querySelectorAll('.menu-content').forEach(m => m.style.display = 'none');
  document.getElementById(`menu-${i}`).style.display = 'block';
}

/* ================= VIEW ================= */
function viewSong(i) {
  lastScrollY = window.scrollY;

  current = i;
  transposeStep = 0;

  document.getElementById('pageList').classList.add('hidden');
  document.getElementById('pageEditor').classList.remove('hidden');

  animateSongChange(0);
}

/* ================= BACK ================= */
function backToList() {
  document.getElementById('pageEditor').classList.add('hidden');
  document.getElementById('pageList').classList.remove('hidden');

  requestAnimationFrame(() => {
    window.scrollTo(0, lastScrollY);
  });
}

/* ================= EDIT ================= */
async function editTitle(i) {
  const t = prompt('Judul lagu:', titles[i]);
  if (!t) return;

  titles[i] = t;
  await setDoc(doc(db, "songs", `song_${i}`), {
    title: t,
    content: songs[i] || ''
  }, { merge: true });

  init();
}

function editSong(i) {
  current = i;
  document.getElementById('editTitle').innerText = titles[i];
  document.getElementById('editor').value = songs[i];
  document.getElementById('editModal').classList.add('show');
}

function closeModal(id) {
  document.getElementById(id).classList.remove('show');
}

async function saveSong() {
  await setDoc(doc(db, "songs", `song_${current}`), {
    title: titles[current],
    content: document.getElementById('editor').value
  });
  closeModal('editModal');
}

/* ================= TOOLS ================= */
function transpose(step) {
  transposeStep += step;
  render();
}

function zoom(step) {
  fontSize = Math.min(34, Math.max(12, fontSize + step));
  render();
}

function transposeChord(ch) {
  const base = ch.match(/^[A-G][#b]?/);
  if (!base) return ch;

  const i = KEYS.indexOf(base[0]);
  if (i < 0) return ch;

  return ch.replace(base[0],
    KEYS[(i + transposeStep + KEYS.length) % KEYS.length]
  );
}

/* ================= RENDER ================= */
function render() {
  const viewer = document.getElementById('viewer');
  viewer.style.fontSize = fontSize + 'px';

  const chordRegex =
    /(?<!\S)([A-G](?:#|b)?(?:m|maj|min|sus|dim|aug|add)?\d*(?:\/[A-G](?:#|b)?\d*)?)(?!\S)/g;

  viewer.innerHTML = (songs[current] || '')
    .split('\n')
    .map(line => {
      if (/^.+\s:\s*$/.test(line)) {
        return `<div class="section">${line}</div>`;
      }
      return line.replace(chordRegex, c =>
        `<span class="chord">${transposeChord(c)}</span>`
      );
    })
    .join('<br>');

  document.getElementById('songTitle').innerText = titles[current];
}

/* ================= SLIDE ANIMATION ================= */
function animateSongChange(direction) {
  if (isAnimating) return;
  isAnimating = true;

  const viewer = document.getElementById('viewer');
  const title = document.getElementById('songTitle');

  viewer.style.transition = 'none';
  title.style.transition = 'none';

  viewer.style.transform = `translateX(${direction * 40}px)`;
  title.style.transform = `translateX(${direction * 40}px)`;

  render();

  requestAnimationFrame(() => {
    viewer.style.transition = 'transform 0.35s ease, opacity 0.35s ease';
    title.style.transition = 'transform 0.35s ease, opacity 0.35s ease';

    viewer.style.transform = 'translateX(0)';
    title.style.transform = 'translateX(0)';
    viewer.style.opacity = '1';
    title.style.opacity = '1';

    setTimeout(() => isAnimating = false, 350);
  });

  window.scrollTo(0, 0);
}

/* ================= NEXT / PREV ================= */
function nextSong() {
  if (current < TOTAL - 1) {
    current++;
    transposeStep = 0;
    animateSongChange(-1);
  }
}

function prevSong() {
  if (current > 0) {
    current--;
    transposeStep = 0;
    animateSongChange(1);
  }
}

/* ================= SWIPE ================= */
const editorPage = document.getElementById('pageEditor');

editorPage.addEventListener('touchstart', e => {
  if (e.touches.length === 1) {
    touchStartX = e.touches[0].clientX;
  }
});

editorPage.addEventListener('touchend', e => {
  touchEndX = e.changedTouches[0].clientX;
  const diff = touchStartX - touchEndX;
  const threshold = 70;

  if (Math.abs(diff) < threshold) return;

  diff > 0 ? nextSong() : prevSong();
});

/* ================= GLOBAL ================= */
window.transpose = transpose;
window.zoom = zoom;
window.backToList = backToList;
window.viewSong = viewSong;
window.editSong = editSong;
window.toggleMenu = toggleMenu;
window.closeModal = closeModal;
window.saveSong = saveSong;
window.editTitle = editTitle;
</script>

</body>
</html>
