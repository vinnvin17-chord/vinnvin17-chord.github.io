<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Catatan Chord</title>
  <!-- Import Font Anime-Inspired -->
  <link href="https://fonts.googleapis.com/css2?family=Fredoka+One&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: linear-gradient(135deg, #2d1b69 0%, #11998e 100%); /* Gradien ungu-biru anime */
      --card: rgba(255, 255, 255, 0.1); /* Transparan dengan blur untuk efek glassmorphism */
      --card-soft: rgba(255, 255, 255, 0.2);
      --primary: #ff6b9d; /* Pink neon */
      --secondary: #4ecdc4; /* Cyan anime */
      --text: #ffffff; /* Putih cerah */
      --muted: #b8c5d6; /* Abu-abu pastel */
      --border: rgba(255, 255, 255, 0.3);
      --shadow: rgba(255, 105, 157, 0.3); /* Glow pink */
      --transition: all 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55); /* Bounce effect */
    }
    * {
      box-sizing: border-box;
    }
    body {
      margin: 0;
      font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
      background: var(--bg);
      background-image: url('https://images.unsplash.com/photo-1578662996442-48f60103fc96?ixlib=rb-4.0.3&auto=format&fit=crop&w=1000&q=80'); /* Gambar anime background (sakura/chibi - ganti dengan URL favoritmu) */
      background-size: cover;
      background-attachment: fixed;
      background-position: center;
      color: var(--text);
      transition: var(--transition);
      min-height: 100vh;
      position: relative;
    }
    body::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.4); /* Overlay gelap agar teks readable */
      z-index: -1;
    }
    body.modal-open {
      overflow: hidden; /* Cegah scroll saat modal aktif */
    }
    h1 {
      font-family: 'Fredoka One', cursive; /* Font anime kartun */
      font-size: 24px;
      font-weight: 600;
      margin: 0;
      padding: 20px;
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      border-bottom: 2px solid var(--border);
      box-shadow: 0 4px 12px var(--shadow);
      text-shadow: 0 0 10px var(--primary);
      border-radius: 20px 20px 0 0;
    }
    h2 {
      font-family: 'Fredoka One', cursive;
      font-size: 18px;
      font-weight: 500;
      margin: 20px 0 10px;
      color: var(--primary);
      text-shadow: 0 0 8px var(--primary);
    }
    button {
      appearance: none;
      border: none;
      background: var(--card-soft);
      backdrop-filter: blur(10px);
      color: var(--text);
      padding: 12px 16px;
      border-radius: 25px; /* Lebih bulat untuk kesan anime */
      font-size: 14px;
      font-family: 'Fredoka One', cursive;
      cursor: pointer;
      transition: var(--transition);
      box-shadow: 0 2px 8px var(--shadow);
      border: 1px solid var(--border);
    }
    button:hover {
      background: var(--primary);
      transform: translateY(-3px) scale(1.05);
      box-shadow: 0 4px 20px rgba(255, 107, 157, 0.6);
    }
    button:active {
      transform: scale(0.95);
    }
    .hidden {
      display: none;
    }
    .fade-in {
      animation: fadeInBounce 0.6s ease-in-out;
    }
    @keyframes fadeInBounce {
      0% { opacity: 0; transform: translateY(20px) scale(0.9); }
      50% { opacity: 0.5; transform: translateY(-5px) scale(1.02); }
      100% { opacity: 1; transform: translateY(0) scale(1); }
    }

    /* MODAL */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      backdrop-filter: blur(5px);
      z-index: 1000;
      justify-content: center;
      align-items: center;
      pointer-events: none; /* Default off */
    }
    .modal.show {
      display: flex;
      pointer-events: auto; /* Aktif saat show */
    }
    .modal-content {
      background: var(--card);
      backdrop-filter: blur(15px);
      border-radius: 30px; /* Lebih bulat */
      padding: 25px;
      max-width: 90%;
      max-height: 90%;
      overflow-y: auto;
      box-shadow: 0 10px 40px var(--shadow);
      width: 100%;
      border: 2px solid var(--border);
      z-index: 1001; /* Pastikan di atas semuanya */
      position: relative;
    }
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }
    .modal-close {
      background: none;
      border: none;
      color: var(--muted);
      font-size: 28px;
      cursor: pointer;
      transition: var(--transition);
    }
    .modal-close:hover {
      color: var(--primary);
      transform: rotate(90deg);
    }

    /* PAGE LIST */
    #pageList {
      padding: 20px;
    }
    .group {
      margin-bottom: 30px;
    }
    .song-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      width: 100%;
      text-align: left;
      margin-bottom: 15px;
      padding: 18px 22px;
      background: var(--card);
      backdrop-filter: blur(10px);
      border: 1px solid var(--border);
      font-size: 16px;
      font-family: 'Fredoka One', cursive;
      border-radius: 20px;
      box-shadow: 0 4px 12px var(--shadow);
      cursor: pointer;
      transition: var(--transition);
    }
    .song-item:hover {
      background: var(--card-soft);
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(255, 107, 157, 0.4);
    }
    .song-title {
      flex: 1;
    }
    .menu-btn {
      background: none;
      border: none;
      color: var(--muted);
      font-size: 20px;
      cursor: pointer;
      padding: 0;
      margin-left: 10px;
      transition: var(--transition);
    }
    .menu-btn:hover {
      color: var(--primary);
      transform: rotate(45deg);
    }
    .menu {
      position: relative;
      display: inline-block;
    }
    .menu-content {
      display: none;
      position: absolute;
      right: 0;
      top: 100%;
      background: var(--card);
      backdrop-filter: blur(10px);
      border: 1px solid var(--border);
      border-radius: 15px;
      box-shadow: 0 4px 12px var(--shadow);
      z-index: 100;
      min-width: 140px;
    }
    .menu-content button {
      width: 100%;
      text-align: left;
      border-radius: 0;
      margin: 0;
      padding: 12px 16px;
      font-family: 'Fredoka One', cursive;
    }
    .menu-content button:first-child {
      border-radius: 15px 15px 0 0;
    }
    .menu-content button:last-child {
      border-radius: 0 0 15px 15px;
    }

    /* EDITOR IN MODAL */
    .editor-modal textarea {
      width: 100%;
      height: 300px;
      background: var(--card);
      backdrop-filter: blur(10px);
      color: var(--text);
      border: 2px solid var(--border);
      border-radius: 20px;
      padding: 18px;
      font-size: 16px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      resize: vertical;
      transition: var(--transition);
      white-space: pre;
    }
    .editor-modal textarea:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 4px rgba(255, 107, 157, 0.3);
    }
    .editor-modal .actions {
      display: flex;
      gap: 10px;
      margin-top: 16px;
    }

    /* VIEWER */
    .viewer {
      background: var(--card);
      backdrop-filter: blur(15px);
      border: 2px solid var(--border);
      border-radius: 25px;
      padding: 25px;
      margin-top: 16px;
      line-height: 2;
      box-shadow: 0 6px 20px var(--shadow);
      overflow-x: auto;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      white-space: pre;
    }
    .section {
      font-weight: 700;
      letter-spacing: 0.5px;
      margin: 20px 0 8px;
      color: var(--text);
      font-size: 14px;
      text-shadow: 0 0 5px var(--primary);
    }
    .chord {
      color: var(--primary);
      font-weight: 600;
      text-shadow: 0 0 8px var(--primary);
    }

    /* TOOLBAR */
    .toolbar {
      position: sticky;
      top: 0;
      z-index: 50;
      display: flex;
      gap: 10px;
      padding: 15px 20px;
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(15px);
      border-bottom: 2px solid var(--border);
      box-shadow: 0 4px 12px var(--shadow);
      border-radius: 0 0 20px 20px;
    }
    .toolbar button {
      font-size: 14px;
      font-family: 'Fredoka One', cursive;
    }

    /* RESPONSIVE */
    @media (max-width: 768px) {
      .modal-content {
        max-width: 95%;
        padding: 20px;
      }
      .toolbar {
        padding: 12px 16px;
        flex-wrap: wrap;
      }
      .viewer {
        padding: 18px;
        font-size: 14px;
      }
      h1 {
        font-size: 20px;
        padding: 16px 18px;
      }
      .song-item {
        padding: 16px 18px;
        font-size: 14px;
      }
    }
  </style>
</head>
<body>

<!-- PAGE 1 -->
<div id="pageList" class="fade-in">
  <h1>üé∂ Daftar Lagu üé∂</h1>
  <div style="text-align: right; margin-bottom: 20px;">
    <button onclick="exportSongs()">‚¨á Export</button>
    <label for="importFile" style="margin-left: 10px;">
      <button>üìÅ Import</button>
    </label>
    <input type="file" id="importFile" onchange="importSongs(event)" style="display: none;" />
  </div>
  <div class="group">
    <h2>üå∏ JCC</h2>
    <div id="songButtons1"></div>
  </div>
</div>

<!-- PAGE 2 -->
<div id="pageEditor" class="hidden fade-in">
  <button onclick="backToList()">‚¨Ö Kembali</button>
  <h1 id="songTitle"></h1>

  <div class="toolbar">
    <button onclick="transpose(-1)">‚≠ê Transpose -</button>
    <button onclick="transpose(1)">‚≠ê Transpose +</button>
    <button onclick="zoom(1)">üëÅÔ∏è Zoom +</button>
    <button onclick="zoom(-1)">üëÅÔ∏è Zoom -</button>
  </div>

  <div id="viewer" class="viewer"></div>
</div>

<!-- MODAL EDIT -->
<div id="editModal" class="modal">
  <div class="modal-content editor-modal">
    <div class="modal-header">
      <h1 id="editTitle"></h1>
      <button class="modal-close" onclick="closeModal('editModal')">√ó</button>
    </div>
    <textarea id="editor" placeholder="Masukkan chord dan lirik di sini..."></textarea>
    <div class="actions">
      <button onclick="saveSong()">üíæ Simpan</button>
    </div>
  </div>
</div>

<script type="module">
/* ================= FIREBASE ================= */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
  getFirestore,
  collection,
  doc,
  addDoc,
  updateDoc,
  deleteDoc,
  onSnapshot
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyC1pwhv_VtD1Zkc61kBntnBZWlCLeFSod0",
  authDomain: "catatan-chord-7fa25.firebaseapp.com",
  projectId: "catatan-chord-7fa25",
  storageBucket: "catatan-chord-7fa25.firebasestorage.app",
  messagingSenderId: "559468614740",
  appId: "1:559468614740:web:dd6f9b99e314037524c9c1"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

/* ================= KONFIG ================= */
const KEYS = ['C','C#','D','D#','E','F','F#','G','G#','A','Bb','B'];

/* ================= STATE ================= */
let songs = [];              // {id,title,content}
let currentIndex = 0;
let transposeStep = 0;
let fontSize = 18;
let lastScrollY = 0;

/* swipe */
let touchStartX = 0;
let touchEndX = 0;
let isAnimating = false;

/* ================= FIRESTORE ================= */
onSnapshot(collection(db, "songs"), snap => {
  songs = [];
  snap.forEach(d => {
    songs.push({
      id: d.id,
      title: d.data().title || 'Tanpa Judul',
      content: d.data().content || ''
    });
  });
  init();
});

/* ================= INIT ================= */
function init() {
  renderList();
}

/* ================= LIST ================= */
function renderList() {
  const box = document.getElementById('songButtons1');
  box.innerHTML = '';

  songs.forEach((song, i) => {
    const item = document.createElement('div');
    item.className = 'song-item';
    item.onclick = () => viewSong(i);

    item.innerHTML = `
      <span class="song-title">${song.title}</span>
      <div class="menu">
        <button class="menu-btn" onclick="event.stopPropagation(); toggleMenu(${i})">‚ãÆ</button>
        <div id="menu-${i}" class="menu-content">
          <button onclick="event.stopPropagation(); editTitle(${i})">Edit Judul</button>
          <button onclick="event.stopPropagation(); editSong(${i})">Edit Lagu</button>
          <button onclick="event.stopPropagation(); deleteSong(${i})">Hapus</button>
        </div>
      </div>
    `;
    box.appendChild(item);
  });
}

function toggleMenu(i) {
  document.querySelectorAll('.menu-content').forEach(m => m.style.display = 'none');
  document.getElementById(`menu-${i}`).style.display = 'block';
}

/* ================= VIEW ================= */
function viewSong(i) {
  lastScrollY = window.scrollY;
  currentIndex = i;
  transposeStep = 0;

  document.getElementById('pageList').classList.add('hidden');
  document.getElementById('pageEditor').classList.remove('hidden');

  animateSongChange(0);
}

/* ================= BACK ================= */
function backToList() {
  document.getElementById('pageEditor').classList.add('hidden');
  document.getElementById('pageList').classList.remove('hidden');
  requestAnimationFrame(() => window.scrollTo(0, lastScrollY));
}

/* ================= EDIT ================= */
async function editTitle(i) {
  const t = prompt('Judul lagu:', songs[i].title);
  if (!t) return;

  songs[i].title = t;
  await updateDoc(doc(db, "songs", songs[i].id), { title: t });
  init();
}

function editSong(i) {
  currentIndex = i;
  document.getElementById('editTitle').innerText = songs[i].title;
  document.getElementById('editor').value = songs[i].content;
  document.getElementById('editModal').classList.add('show');
  document.body.classList.add('modal-open');
}

function closeModal(id) {
  document.getElementById(id).classList.remove('show');
  document.body.classList.remove('modal-open');
}

async function saveSong() {
  const text = document.getElementById('editor').value;
  songs[currentIndex].content = text;

  await updateDoc(doc(db, "songs", songs[currentIndex].id), {
    content: text
  });

  closeModal('editModal');
  render();
}

/* ================= ADD / DELETE ================= */
async function addSong() {
  await addDoc(collection(db, "songs"), {
    title: "Lagu Baru",
    content: "",
    createdAt: Date.now()
  });
}

async function deleteSong(i) {
  if (!confirm('Hapus lagu ini?')) return;
  await deleteDoc(doc(db, "songs", songs[i].id));
}

/* ================= TOOLS ================= */
function transpose(step) {
  transposeStep += step;
  render();
}

function zoom(step) {
  fontSize = Math.min(34, Math.max(12, fontSize + step));
  render();
}

function transposeChord(ch) {
  const base = ch.match(/^[A-G][#b]?/);
  if (!base) return ch;
  const i = KEYS.indexOf(base[0]);
  if (i < 0) return ch;
  return ch.replace(base[0], KEYS[(i + transposeStep + KEYS.length) % KEYS.length]);
}

/* ================= RENDER ================= */
function render() {
  const viewer = document.getElementById('viewer');
  viewer.style.fontSize = fontSize + 'px';

  const chordRegex = /(?<!\S)([A-G](?:#|b)?(?:m|maj|min|sus|dim|aug|add)?\d*(?:\/[A-G](?:#|b)?\d*)?)(?!\S)/g;

  viewer.innerHTML = (songs[currentIndex]?.content || '')
    .split('\n')
    .map(line => {
      if (/^.+\s:\s*$/.test(line)) {
        return `<div class="section">${line}</div>`;
      }
      return line.replace(chordRegex, c =>
        `<span class="chord">${transposeChord(c)}</span>`
      );
    }).join('<br>');

  document.getElementById('songTitle').innerText = songs[currentIndex]?.title || '';
}

/* ================= ANIMATION ================= */
function animateSongChange(direction) {
  if (isAnimating) return;
  isAnimating = true;

  const viewer = document.getElementById('viewer');
  const title = document.getElementById('songTitle');

  viewer.style.transform = `translateX(${direction * 40}px)`;
  title.style.transform = `translateX(${direction * 40}px)`;

  render();

  requestAnimationFrame(() => {
    viewer.style.transition = 'transform 0.35s ease';
    title.style.transition = 'transform 0.35s ease';
    viewer.style.transform = 'translateX(0)';
    title.style.transform = 'translateX(0)';
    setTimeout(() => isAnimating = false, 350);
  });

  window.scrollTo(0, 0);
}

/* ================= NEXT / PREV ================= */
function nextSong() {
  if (currentIndex < songs.length - 1) {
    currentIndex++;
    transposeStep = 0;
    animateSongChange(-1);
  }
}

function prevSong() {
  if (currentIndex > 0) {
    currentIndex--;
    transposeStep = 0;
    animateSongChange(1);
  }
}

/* ================= SWIPE ================= */
const editorPage = document.getElementById('pageEditor');
editorPage.addEventListener('touchstart', e => {
  if (e.touches.length === 1) touchStartX = e.touches[0].clientX;
});
editorPage.addEventListener('touchend', e => {
  touchEndX = e.changedTouches[0].clientX;
  const diff = touchStartX - touchEndX;
  if (Math.abs(diff) < 70) return;
  diff > 0 ? nextSong() : prevSong();
});

/* ================= EXPORT ================= */
window.transpose = transpose;
window.zoom = zoom;
window.backToList = backToList;
window.viewSong = viewSong;
window.editSong = editSong;
window.toggleMenu = toggleMenu;
window.closeModal = closeModal;
window.saveSong = saveSong;
window.editTitle = editTitle;
window.addSong = addSong;
</script>


</body>
</html>
